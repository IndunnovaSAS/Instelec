<form method="post" class="space-y-6" hx-post="{% url 'campo:crear' %}" hx-target="#modal-container">
    {% csrf_token %}

    {% if error %}
    <div class="p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg">
        {{ error }}
    </div>
    {% endif %}

    <div>
        <label for="linea" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Linea
        </label>
        <select id="linea" name="linea"
                class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                onchange="filterActividades(this.value)">
            <option value="">Seleccione una linea</option>
            {% for linea in lineas %}
            <option value="{{ linea.id }}">{{ linea.codigo }} - {{ linea.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <div>
        <label for="actividad" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Actividad *
        </label>
        <select id="actividad" name="actividad" required
                class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700">
            <option value="">Seleccione una actividad</option>
            {% for actividad in actividades %}
            <option value="{{ actividad.id }}"
                    data-linea="{{ actividad.linea.id }}"
                    {% if actividad_seleccionada == actividad.id|stringformat:"s" %}selected{% endif %}>
                {{ actividad.tipo_actividad.nombre }} - Torre {{ actividad.torre.numero }} ({{ actividad.linea.codigo }})
            </option>
            {% endfor %}
        </select>
    </div>

    <div>
        <label for="observaciones" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Observaciones
        </label>
        <textarea id="observaciones" name="observaciones" rows="4"
                  class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                  placeholder="Observaciones del registro de campo..."></textarea>
    </div>

    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
        <button type="button" onclick="closeModal()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
            Cancelar
        </button>
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Crear Registro
        </button>
    </div>
</form>

<script>
function filterActividades(lineaId) {
    const select = document.getElementById('actividad');
    const options = select.querySelectorAll('option');

    options.forEach(option => {
        if (option.value === '') {
            return;
        }
        const optionLinea = option.dataset.linea;
        if (!lineaId || optionLinea === lineaId) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });

    // Reset selection if current selection is hidden
    if (select.selectedOptions[0] && select.selectedOptions[0].style.display === 'none') {
        select.value = '';
    }
}

function closeModal() {
    const modal = document.getElementById('modal-container');
    if (modal) {
        modal.innerHTML = '';
    }
}
</script>
