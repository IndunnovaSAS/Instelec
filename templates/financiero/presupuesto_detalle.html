{% extends "base.html" %}

{% block title %}Presupuesto {{ presupuesto.mes }}/{{ presupuesto.anio }} - TransMaint{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex items-center gap-4">
            <a href="{% url 'financiero:presupuestos' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    Presupuesto {{ presupuesto.mes }}/{{ presupuesto.anio }}
                </h1>
                <p class="text-gray-600 dark:text-gray-400">{{ presupuesto.linea.codigo }} - {{ presupuesto.linea.nombre }}</p>
            </div>
        </div>
        <a href="{% url 'financiero:cuadro_costos' %}?mes={{ presupuesto.mes }}&anio={{ presupuesto.anio }}&linea={{ presupuesto.linea.id }}"
           class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Cuadro de Costos
        </a>
    </div>

    <!-- Status Banner -->
    <div class="rounded-lg p-4
        {% if presupuesto.estado == 'CERRADO' %}bg-green-100 dark:bg-green-900/30 border border-green-300
        {% elif presupuesto.estado == 'EN_EJECUCION' %}bg-blue-100 dark:bg-blue-900/30 border border-blue-300
        {% elif presupuesto.estado == 'APROBADO' %}bg-purple-100 dark:bg-purple-900/30 border border-purple-300
        {% else %}bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300{% endif %}">
        <div class="flex items-center justify-between">
            <span class="font-medium
                {% if presupuesto.estado == 'CERRADO' %}text-green-800 dark:text-green-200
                {% elif presupuesto.estado == 'EN_EJECUCION' %}text-blue-800 dark:text-blue-200
                {% elif presupuesto.estado == 'APROBADO' %}text-purple-800 dark:text-purple-200
                {% else %}text-yellow-800 dark:text-yellow-200{% endif %}">
                Estado: {{ presupuesto.get_estado_display }}
            </span>
            <span class="text-sm
                {% if presupuesto.desviacion > 10 %}text-red-600
                {% elif presupuesto.desviacion < -10 %}text-green-600
                {% else %}text-gray-600{% endif %}">
                Desviacion: {% if presupuesto.desviacion > 0 %}+{% endif %}{{ presupuesto.desviacion|floatformat:1 }}%
            </span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Budget Summary -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Resumen de Presupuesto</h2>
            <dl class="space-y-3">
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Dias Hombre</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">{{ presupuesto.dias_hombre_planeados }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Costo Dias Hombre</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">${{ presupuesto.costo_dias_hombre|floatformat:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Dias Vehiculo</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">{{ presupuesto.dias_vehiculo_planeados }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Costo Vehiculos</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">${{ presupuesto.costo_vehiculos|floatformat:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Viaticos</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">${{ presupuesto.viaticos_planeados|floatformat:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Otros Costos</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">${{ presupuesto.otros_costos|floatformat:0 }}</dd>
                </div>
                <div class="pt-3 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                    <dt class="font-semibold text-gray-900 dark:text-white">TOTAL PRESUPUESTADO</dt>
                    <dd class="font-bold text-gray-900 dark:text-white">${{ presupuesto.total_presupuestado|floatformat:0 }}</dd>
                </div>
            </dl>
        </div>

        <!-- Execution Summary -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ejecucion</h2>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Ejecutado</span>
                        <span class="font-medium text-gray-900 dark:text-white">${{ presupuesto.total_ejecutado|floatformat:0 }}</span>
                    </div>
                    <div class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full">
                        {% with pct=presupuesto.total_ejecutado|divisibleby:presupuesto.total_presupuestado %}
                        <div class="h-full rounded-full
                            {% if pct > 100 %}bg-red-500{% elif pct > 80 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                            style="width: {% if presupuesto.total_presupuestado > 0 %}{{ presupuesto.total_ejecutado|divisibleby:presupuesto.total_presupuestado|floatformat:0 }}{% else %}0{% endif %}%">
                        </div>
                        {% endwith %}
                    </div>
                </div>
                <div class="pt-4">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Disponible</span>
                        <span class="font-medium
                            {% with disponible=presupuesto.total_presupuestado|add:presupuesto.total_ejecutado|default:0 %}
                            {% if disponible < 0 %}text-red-600{% else %}text-green-600{% endif %}
                            {% endwith %}">
                            ${{ presupuesto.total_presupuestado|add:presupuesto.total_ejecutado|floatformat:0 }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Facturacion</h2>
            <dl class="space-y-3">
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Facturacion Esperada</dt>
                    <dd class="font-medium text-gray-900 dark:text-white">${{ presupuesto.facturacion_esperada|floatformat:0 }}</dd>
                </div>
                <div class="flex justify-between">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Utilidad Proyectada</dt>
                    <dd class="font-medium
                        {% if presupuesto.utilidad_proyectada > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        ${{ presupuesto.utilidad_proyectada|floatformat:0 }}
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Observations -->
    {% if presupuesto.observaciones %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Observaciones</h2>
        <p class="text-gray-600 dark:text-gray-400">{{ presupuesto.observaciones }}</p>
    </div>
    {% endif %}

    <!-- Cost Executions -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Detalle de Ejecucion</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Concepto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actividad</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">C. Unitario</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for ejecucion in ejecuciones %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-400">
                            {{ ejecucion.fecha|date:"d/m/Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">
                            {{ ejecucion.concepto }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                {{ ejecucion.get_tipo_recurso_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600 dark:text-gray-400">
                            {% if ejecucion.actividad %}
                            <a href="{% url 'actividades:detalle' ejecucion.actividad.id %}" class="text-blue-600 hover:text-blue-800">
                                Torre {{ ejecucion.actividad.torre.numero }}
                            </a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-600 dark:text-gray-400">
                            {{ ejecucion.cantidad }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-600 dark:text-gray-400">
                            ${{ ejecucion.costo_unitario|floatformat:0 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-medium text-gray-900 dark:text-white">
                            ${{ ejecucion.costo_total|floatformat:0 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            No hay ejecuciones registradas
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
